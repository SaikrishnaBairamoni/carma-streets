\hypertarget{md_tsc_client_service_README_autotoc_md104}{}\doxysection{Introduction}\label{md_tsc_client_service_README_autotoc_md104}
This is the {\bfseries{TSC Service}} ({\bfseries{Traffic Signal Controller Service}}) meant to be a communication interface between CARMA-\/\+Streets and a {\bfseries{Traffic Signal Controller}} (TSC). The service uses {\bfseries{net-\/snmp}} library to implement a client that can GET and SET specified OIDs from a TSC. Current implementation allows the client to establish communication with a configurable host through snmp versions 1 and 2.

The configurable parameters are defined in the {\ttfamily manifest.\+json} and include {\bfseries{ip}}, {\bfseries{port}} for the snmp server. Currently snmp version 3 is {\itshape not} supported as it requires authentication. Most signal controllers only support NTCIP 1202 v2 currently.

The {\bfseries{TSC Service}} has several responsibilies. The first is to make {\bfseries{SNMP GET}} calls to the {\bfseries{TSC}} on startup to get configuration information which includes\+:
\begin{DoxyItemize}
\item Phase Number (NTCIP) to Signal Group (J2735) Mapping for all phases (Pedestrian and Vehicle) (Found in the Channel\+Table)
\item Phase Sequence for Rings 1 and 2 (Vehicle Phases)(Found in Sequence\+Table)
\item Phase red clearance , yellow change, and minimum/maximun green times (Found in Phase\+Table)
\end{DoxyItemize}

This information is required for predicting traffic signal controller state and for interpeting the {\bfseries{NTCIP UDP SPaT}} data that is broadcast by the TSC. The TSC can be configured to broadcast state information to a configurable host and port via UDP. Broadcasted messages contain information about phases, their current state, and time offset information about when they will change. One of the {\bfseries{TSC Services}} other responsibities is to read these state messages and translate them to {\bfseries{J2735 SPaT}} information. This requires the phase number to signal group mapping queried and startup as well as several unit/timing conversions from offsets to absolute times. The {\bfseries{TSC Service}} will translate each incoming message and broadcast it, in JSON format, on the {\bfseries{CARMA-\/\+Streets}} Kafka broker to a configurable topic( default \+: {\ttfamily modified\+\_\+spat}). Other {\bfseries{CARMA-\/\+Streets}} service can then subscribe to this topic and receive information about the current state of the {\bfseries{TSC}}.

The final responsibility of the {\bfseries{TSC}} is to make {\bfseries{SNMP SET}} calls to the {\bfseries{TSC}} to modify its default signal phase sequence and timing. This {\bfseries{TSC}} will use the SET calls on the following {\bfseries{OIDs}} to achieve this\+:
\begin{DoxyItemize}
\item HOLD
\item OMIT
\item FORCE\+\_\+\+OFF
\end{DoxyItemize}

Modification of the {\bfseries{TSC}} default signal phase sequence and timing is done based on the output of the {\bfseries{SO Service (Signal Optimization)}}. This output is referred to as the {\bfseries{Desired Phase Plan}} and consists of future desired phases and green timing intervals. The {\bfseries{TSC Service}} will consume these messages from the {\bfseries{SO Service}} on every phase transition (Yellow Change) and attempt to send the appropriate SNMP commands to NTCIP OIDs to make the {\bfseries{TSC}} reflect this behavior. The {\bfseries{TSC Service}} will also populate the JSON J2735 {\bfseries{SPaT}} with {\bfseries{Desired Phase Plan}} information as future state informat in the form of {\bfseries{Movement\+Events}} (See J2735 SPaT definition).\hypertarget{md_tsc_client_service_README_autotoc_md105}{}\doxysection{tsc\+\_\+service}\label{md_tsc_client_service_README_autotoc_md105}
The main class in the {\bfseries{TSC Service}} is the {\ttfamily tsc\+\_\+service} class. This class is used to load configuration values from the {\ttfamily manifest.\+json} file, initialize any objects and launches any joined or detached threads of execution. Some important data stored in this class include the {\ttfamily spat} pointer (see \mbox{\hyperlink{streets__utils_2streets__signal__phase__and__timing_2README_8md}{streets\+\_\+utils/streets\+\_\+signal\+\_\+phase\+\_\+and\+\_\+timing/\+README.\+md}}) and {\ttfamily tsc\+\_\+state}. Some important classes initialize here as well include the {\ttfamily snmp\+\_\+client}, {\ttfamily \mbox{\hyperlink{classintersection__client}{intersection\+\_\+client}}}, {\ttfamily spat\+\_\+worker} and a {\ttfamily kafka\+\_\+producer} for producing modified SPaT JSON messages (see \mbox{\hyperlink{namespacekafka__clients}{kafka\+\_\+clients}} README.\+md).

This information is requested and stored in the {\ttfamily tsc\+\_\+state} object, which on intialization, uses an {\ttfamily snmp\+\_\+client} to query this information from the TSC.

The {\ttfamily snmp\+\_\+client} is a class which encapsulates the {\bfseries{net-\/snmp}} connection logic and converts SNMP responses to their {\ttfamily std\+::string} or {\ttfamily int} equivalents. The constructor requires {\bfseries{host}}, {\bfseries{port}}, {\bfseries{version}}, {\bfseries{community}} and {\bfseries{timeout}} information to initialize a connection. To make a request simply use the {\ttfamily process\+\_\+snmp\+\_\+request} method. It takes an {\bfseries{NTCIP OID}} which describes the data you are querying/setting on the {\bfseries{TSC}}, a {\bfseries{request\+\_\+type}} which is an enumeration describing whether you want to use SNMP SET/\+GET, and a {\ttfamily snmp\+\_\+response\+\_\+obj} which is a struct that will be populated by the metho with the SNMP server response.

The {\ttfamily \mbox{\hyperlink{classintersection__client}{intersection\+\_\+client}}} is a REST client implemented using the {\ttfamily streets\+\_\+utils/streets\+\_\+api/intersection\+\_\+client\+\_\+api} library ( see README.\+md for further documentation). It is used to obtain information from the J2735 MAP message, mainly the intersection id and intersection name, to populate the outgoing SPaT message.

The {\ttfamily spat\+\_\+worker} is a class which encapsulates a UDP socket listener. This socket listener, listens for UDP NTCIP data packets set from the {\bfseries{TSC}} at 10 hz that provide traffic signal state information required for populating the {\bfseries{SPaT}}. The {\ttfamily spat\+\_\+worker} contains a method to consume a UDP datapacket and update the {\ttfamily spat} pointer which stores the most up-\/to-\/date information of the traffic signal controller state. The {\ttfamily tsc\+\_\+service} {\ttfamily spat\+\_\+thread} then continously consumes these messages and publishes the resulting {\bfseries{SPaT}} JSON on the CARMA-\/\+Streets Kafka broker. 