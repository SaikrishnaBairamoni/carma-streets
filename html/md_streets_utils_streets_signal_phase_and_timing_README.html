<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carma-streets: Streets Signal Phase and Timing Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Carma-streets
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Streets Signal Phase and Timing Library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md90"></a>
Introduction</h1>
<p>This CARMA-Streets library is meant to handle JSON serialization and deserialization for the CARMA-Streets internal SPaT JSON message. The message structure is heavily based on the J2735 SPaT message but does not contain any regional extension data since we are currently not using it. Below is a sample SPaT JSON message created by this library. </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;time_stamp&quot;:130,</div>
<div class="line">    &quot;name&quot;:&quot;&quot;,</div>
<div class="line">    &quot;intersections&quot;:[</div>
<div class="line">        {</div>
<div class="line">            &quot;name&quot;:&quot;West Intersection&quot;,</div>
<div class="line">            &quot;id&quot;:1909,</div>
<div class="line">            &quot;revision&quot;:123,</div>
<div class="line">            &quot;status&quot;:&quot;01001001001&quot;,</div>
<div class="line">            &quot;moy&quot;:34232,</div>
<div class="line">            &quot;time_stamp&quot;:130,</div>
<div class="line">            &quot;enabled_lanes&quot;:[1,3,5],</div>
<div class="line">            &quot;states&quot;:[</div>
<div class="line">                {</div>
<div class="line">                    &quot;movement_name&quot;:&quot;Right Turn&quot;,</div>
<div class="line">                    &quot;signal_group&quot;:4,</div>
<div class="line">                    &quot;state_time_speed&quot;:[</div>
<div class="line">                        {</div>
<div class="line">                            &quot;event_state&quot;:3,</div>
<div class="line">                            &quot;timing&quot;:{</div>
<div class="line">                                &quot;start_time&quot;:0,  </div>
<div class="line">                                &quot;min_end_time&quot;:0,</div>
<div class="line">                                &quot;max_end_time&quot;:0,</div>
<div class="line">                                &quot;likely_time&quot;:0,</div>
<div class="line">                                &quot;confidence&quot;:0</div>
<div class="line">                            },</div>
<div class="line">                            &quot;speeds&quot;:[</div>
<div class="line">                                {</div>
<div class="line">                                    &quot;type&quot;:0,</div>
<div class="line">                                    &quot;speed_limit&quot;:4,</div>
<div class="line">                                    &quot;speed_confidence&quot;:1,</div>
<div class="line">                                    &quot;distance&quot;:5,</div>
<div class="line">                                    &quot;class&quot;:5</div>
<div class="line">                                }</div>
<div class="line">                            ]</div>
<div class="line">                        }],</div>
<div class="line">                        &quot;maneuver_assist_list&quot;:[</div>
<div class="line">                            {</div>
<div class="line">                                &quot;connection_id&quot;:7,</div>
<div class="line">                                &quot;queue_length&quot;:4,</div>
<div class="line">                                &quot;available_storage_length&quot;:8,</div>
<div class="line">                                &quot;wait_on_stop&quot;:true,</div>
<div class="line">                                &quot;ped_bicycle_detect&quot;:false</div>
<div class="line">                            }]</div>
<div class="line">                }],</div>
<div class="line">                &quot;maneuver_assist_list&quot;:[</div>
<div class="line">                    {</div>
<div class="line">                        &quot;connection_id&quot;:7,</div>
<div class="line">                        &quot;queue_length&quot;:4,</div>
<div class="line">                        &quot;available_storage_length&quot;:8,</div>
<div class="line">                        &quot;wait_on_stop&quot;:true,</div>
<div class="line">                        &quot;ped_bicycle_detect&quot;:false</div>
<div class="line">                    }]</div>
<div class="line">        }]</div>
<div class="line">}</div>
</div><!-- fragment --> <h1><a class="anchor" id="autotoc_md91"></a>
SPaT Traffic Signal State Information</h1>
<p>The two relevant portions of the SPaT JSON message for managing traffic signal <b>states</b> MovementList and the <b>state-time-speed</b> MovementEventList. The <b>states</b> MovementList is a list of MovementStates. Each describes the state of a particular movement in the intersection. These can be identified by their <b>signal_group_id</b> which is the unique identifier for the signal group that controls this movement. Inside each MovementState there is a <b>state-time-speed</b> MovementEventList. This is a list of MovementEvents. Each MovementEvent has information about the phase as a MovementPhaseState enumeration and timing information about the start and end time of the described phase. Each MovementEventList can hold 16 possible MovementEvents (limitation of J2735 not this data type) to describe a current phase and up to 15 future phases. Each MovementEvent contains <b>timing</b> information which will include at minimum, <b>start_time</b> and <b>min_end_time</b>. These fields will represent the start and end time for each phase and are represented as tenths of a second in the current or next hour in units of 1/10th second from UTC time.A range of 0~36000 covers one hour.The values 35991..35999 are used when a leap second occurs.The value 36000 is used to indicate time &gt;3600 seconds. 36001 is to be used when value undefined or unknown. Note that this is NOT expressed in GPS time or in local time Below is an example JSON for the described objects.(J2735 TimeMark definition). </p><div class="fragment"><div class="line">&quot;states&quot;:[</div>
<div class="line">    {</div>
<div class="line">        &quot;signal_group&quot;:1,</div>
<div class="line">        &quot;state_time_speed&quot;:[</div>
<div class="line">            {</div>
<div class="line">                &quot;event_state&quot;:3,  // RED light see movement_phase_state</div>
<div class="line">                &quot;timing&quot;:{</div>
<div class="line">                    &quot;start_time&quot;:0,  </div>
<div class="line">                    &quot;min_end_time&quot;:10000</div>
<div class="line">                }</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;event_state&quot;:6,  // Protected GREEN light see movement_phase_state</div>
<div class="line">                &quot;timing&quot;:{</div>
<div class="line">                    &quot;start_time&quot;:10000,  </div>
<div class="line">                    &quot;min_end_time&quot;:25000</div>
<div class="line">                }</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;event_state&quot;:8,  // Protected YELLOW light see movement_phase_state</div>
<div class="line">                &quot;timing&quot;:{</div>
<div class="line">                    &quot;start_time&quot;:25000,  </div>
<div class="line">                    &quot;min_end_time&quot;:30000</div>
<div class="line">                }</div>
<div class="line">            }]</div>
<div class="line">    },</div>
<div class="line">     {</div>
<div class="line">        &quot;signal_group&quot;:2,</div>
<div class="line">        &quot;state_time_speed&quot;:[</div>
<div class="line">            {</div>
<div class="line">                &quot;event_state&quot;:6,  // Protect GREEN light see movement_phase_state</div>
<div class="line">                &quot;timing&quot;:{</div>
<div class="line">                    &quot;start_time&quot;:0,  </div>
<div class="line">                    &quot;min_end_time&quot;:5000</div>
<div class="line">                }</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;event_state&quot;:8,  // Protected YELLOW light see movement_phase_state</div>
<div class="line">                &quot;timing&quot;:{</div>
<div class="line">                    &quot;start_time&quot;:5000,  </div>
<div class="line">                    &quot;min_end_time&quot;:10000</div>
<div class="line">                }</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;event_state&quot;:3,  // RED light see movement_phase_state</div>
<div class="line">                &quot;timing&quot;:{</div>
<div class="line">                    &quot;start_time&quot;:10000,  </div>
<div class="line">                    &quot;min_end_time&quot;:30000</div>
<div class="line">                }</div>
<div class="line">            }]</div>
<div class="line">    }</div>
<div class="line">]</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md92"></a>
Including Library</h1>
<p>To include this library in your CARMA-Streets service simply add the following to your CMakeList.txt. </p><div class="fragment"><div class="line">find_package( streets_signal_phase_and_timing_lib REQUIRED )</div>
<div class="line">...</div>
<div class="line">target_link_libraries( &lt;target&gt; PUBLIC streets_signal_phase_and_timing_lib )</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md93"></a>
Initializing SPaT Object for consuming NTCIP UDP data</h1>
<p>This <code>spat</code> object contains methods to update based on json SPaT updates or ntcip_1202_ext UDP data. For updating using JSON SPaT messages no initialization is required since each update will contain all the required information. Below is an example of how to consume an update. </p><div class="fragment"><div class="line">std::string json; // This string needs to be populated with JSON spat update.</div>
<div class="line">auto spat_ptr = std::make_shared&lt;signal_phase_and_timing::spat&gt;();</div>
<div class="line">// Method to update spat based on SPaT JSON update</div>
<div class="line">spat_ptr-&gt;fromJson( json )</div>
</div><!-- fragment --><p>For consuming <b>NTCIP</b> UDP update messages the <code>spat</code> requires initialization since it requires mapping information between phase numbers (from NTCIP) to signal group ids (from J2735), intersection name, and intersection id not included in the UDP message. An example below illustrates this process. </p><div class="fragment"><div class="line">auto spat_ptr = std::make_shared&lt;signal_phase_and_timing::spat&gt;();</div>
<div class="line"> </div>
<div class="line">// Initialize methods takes parameters : std::string intersection_name (corresponds to J2735 intersection name from MAP </div>
<div class="line">// SPaT), int intersection_id (corresponds to J2735 intersection id from MAP and SPaT), std::unordered_hashmap&lt;int,int&gt;</div>
<div class="line">// phase_number_to_signal_group (Map of phase numbers from NTCIP to signal groups defined in MAP. This information can be</div>
<div class="line">// obtained from the channeltable in the NTCIP server on the TSC, see monitor_tsc_state in tsc_service) </div>
<div class="line"> </div>
<div class="line">spat_ptr-&gt;initialize_intersection( intersection_name, intersection_id, phase_number_to_signal_group)</div>
<div class="line"> </div>
<div class="line">std::vector&lt;char&gt; udp_packet                            // buffer of udp message( this needs to be populated from UDP socket!)</div>
<div class="line">ntcip::ntcip_1202_ext ntcip_1202_data;                  // struct with byte mapping to values for udp message</div>
<div class="line"> </div>
<div class="line">// copy buffer into struct</div>
<div class="line">std::memcpy(&amp;ntcip_1202_data, spat_buf.data(), spat_buf.size()); </div>
<div class="line"> </div>
<div class="line">spat_ptr-&gt;update(ntcip_1202_data, _use_msg_timestamp);  // use struct to update spat, bool flag controls whether to use </div>
<div class="line">                                                        // host machine unix time(if false) or NTCIP UDP message timestamp </div>
<div class="line">                                                        // (if true) </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
